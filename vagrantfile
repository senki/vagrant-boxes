# -*- mode: ruby -*-
# vi: set ft=ruby :

# Copyright (c) 2015 Csaba Maulis
#
# SEE LICENSE File

def local_cache(box_name)
  cache_dir = File.join(File.expand_path("~/.vagrant.d"),
                        'cache',
                        'apt',
                        box_name)
  partial_dir = File.join(cache_dir, 'partial')
  FileUtils.mkdir_p(partial_dir) unless File.exists? partial_dir
  cache_dir
end

Vagrant.configure(2) do |config|

  # build

  config.vm.define "precise" do |precise|
    precise.ssh.insert_key = false
    precise.vm.box = "ubuntu/precise64"
    precise.vm.hostname = "lamp-precise.local"
    precise.vm.provision "shell", path: "src/precise.sh"
    precise.vm.provision "reload"
    cache_dir = local_cache(precise.vm.box)
    precise.vm.synced_folder cache_dir, "/var/cache/apt/archives/"
  end

  config.vm.define "trusty" do |trusty|
    trusty.ssh.insert_key = false
    trusty.vm.box = "ubuntu/trusty64"
    trusty.vm.hostname = "lamp-trusty.local"
    trusty.vm.provision "shell", path: "src/trusty.sh"
    trusty.vm.provision "reload"
    cache_dir = local_cache(trusty.vm.box)
    trusty.vm.synced_folder cache_dir, "/var/cache/apt/archives/"
  end

  # test

  config.vm.define "precise_test" do |precise_test|
    precise_test.vm.box = "ubuntu/precise64"
    precise_test.vm.hostname = "lamp-precise-test.local"
    precise_test.vm.network "private_network", ip:"192.168.33.14"
    precise_test.vm.provision "shell", path: "src/precise.sh", args: "test"
    precise_test.vm.provision "reload"
    cache_dir = local_cache(precise_test.vm.box)
    precise_test.vm.synced_folder cache_dir, "/var/cache/apt/archives/"
  end

  config.vm.define "trusty_test" do |trusty_test|
    trusty_test.vm.box = "ubuntu/trusty64"
    trusty_test.vm.hostname = "lamp-trusty-test.local"
    trusty_test.vm.network "private_network", ip:"192.168.33.15"
    trusty_test.vm.provision "shell", path: "src/trusty.sh", args: "test"
    trusty_test.vm.provision "reload"
    cache_dir = local_cache(trusty_test.vm.box)
    trusty_test.vm.synced_folder cache_dir, "/var/cache/apt/archives/"
  end

end
